# PreferredColorScheme Implementation Summary

## Overview

Added support for controlling the WebView color scheme (Light/Dark/Auto) on Windows platform using WebView2's `ICoreWebView2Profile.PreferredColorScheme` API.

## Date

January 16, 2026

## Feature Description

Implemented a new `preferredColorScheme` setting for `InAppWebViewSettings` that allows developers to control the color scheme of the WebView on Windows. This setting maps to the WebView2 API `ICoreWebView2Profile.PreferredColorScheme` property.

## Requirements

- **Platform**: Windows only
- **WebView2 Runtime Version**: 1.0.1901.177 or higher
- **API**: ICoreWebView2_13.get_Profile() â†’ ICoreWebView2Profile.put_PreferredColorScheme()

---

## Changes Made

### 1. Platform Interface Package (`flutter_inappwebview_platform_interface`)

#### New Files Created

- **`lib/src/types/preferred_color_scheme.dart`**
  - Defined `PreferredColorScheme` enum with three values:
    - `LIGHT` (value: 1) - Light color scheme
    - `DARK` (value: 2) - Dark color scheme
    - `AUTO` (value: 0) - Automatically match the system color scheme
  - Annotated with `@ExchangeableEnum()` for code generation

#### Modified Files

- **`lib/src/types/main.dart`**
  - Added export for `PreferredColorScheme` type

- **`lib/src/in_app_webview/in_app_webview_settings.dart`**
  - Added import for `preferred_color_scheme.dart`
  - Added property declaration:
    ```dart
    @SupportedPlatforms(platforms: [WindowsPlatform(available: "1.0.1901.177+", apiName: "ICoreWebView2Profile.PreferredColorScheme", apiUrl: "https://learn.microsoft.com/en-us/microsoft-edge/webview2/reference/win32/icorewebview2profile?view=webview2-1.0.1901.177#get_preferredcolorscheme")])
    PreferredColorScheme_? preferredColorScheme;
    ```
  - Added constructor parameter with default value `PreferredColorScheme.AUTO`
  - Properly annotated with `@SupportedPlatforms` for Windows platform support

#### Generated Files

- **`lib/src/types/preferred_color_scheme.g.dart`**
  - Auto-generated by `build_runner` with enum conversions, serialization methods
- **`lib/src/in_app_webview/in_app_webview_settings.g.dart`**
  - Regenerated with `preferredColorScheme` support in:
    - Constructor
    - `fromMap()` deserialization
    - `toMap()` serialization
    - Copy methods
    - Documentation

#### CHANGELOG Entry

```markdown
- Added `PreferredColorScheme` enum type with `LIGHT`, `DARK`, and `AUTO` values
- Added `preferredColorScheme` property to `InAppWebViewSettings` (Windows only)
```

---

### 2. Windows Package (`flutter_inappwebview_windows`)

#### Modified Files

##### **`windows/in_app_webview/in_app_webview_settings.h`**

- Added field declaration:
  ```cpp
  std::optional<int64_t> preferredColorScheme;
  ```

##### **`windows/in_app_webview/in_app_webview_settings.cpp`**

1. **Constructor** - Added parsing from Flutter map:

   ```cpp
   if (flutter::HasKey(map, "preferredColorScheme") && !map->at("preferredColorScheme").IsNull()) {
     preferredColorScheme = std::get<int64_t>(map->at("preferredColorScheme"));
   }
   ```

2. **toEncodableMap()** - Added serialization:

   ```cpp
   if (preferredColorScheme.has_value()) {
     settingsMap["preferredColorScheme"] = make_fl_value(*preferredColorScheme);
   }
   ```

3. **getRealSettings()** - Added reading current value from WebView2:
   ```cpp
   if (webView->plugin->webViewEnv->isWebView2VersionAtLeast("1.0.1901.177")) {
     auto webView2_13 = webView->webView.try_query<ICoreWebView2_13>();
     if (webView2_13) {
       wil::com_ptr<ICoreWebView2Profile> profile;
       HRESULT hrProfile = webView2_13->get_Profile(&profile);
       if (SUCCEEDED(hrProfile) && profile) {
         COREWEBVIEW2_PREFERRED_COLOR_SCHEME scheme;
         if (SUCCEEDED(profile->get_PreferredColorScheme(&scheme))) {
           realSettings["preferredColorScheme"] = make_fl_value(static_cast<int64_t>(scheme));
         }
       }
     }
   }
   ```

##### **`windows/in_app_webview/in_app_webview.cpp`**

1. **prepare()** - Added initialization logic:

   ```cpp
   if (plugin->webViewEnv->isWebView2VersionAtLeast("1.0.1901.177") &&
       settings->preferredColorScheme.has_value()) {
     auto webView2_13 = webView.try_query<ICoreWebView2_13>();
     if (webView2_13) {
       wil::com_ptr<ICoreWebView2Profile> profile;
       HRESULT hrProfile = webView2_13->get_Profile(&profile);
       if (SUCCEEDED(hrProfile) && profile) {
         profile->put_PreferredColorScheme(
           static_cast<COREWEBVIEW2_PREFERRED_COLOR_SCHEME>(
             settings->preferredColorScheme.value()));
       }
     }
   }
   ```

2. **setSettings()** - Added runtime update logic:
   ```cpp
   if (plugin->webViewEnv->isWebView2VersionAtLeast("1.0.1901.177") &&
       newSettings->preferredColorScheme.has_value() &&
       (!settings->preferredColorScheme.has_value() ||
        settings->preferredColorScheme.value() != newSettings->preferredColorScheme.value())) {
     auto webView2_13 = webView.try_query<ICoreWebView2_13>();
     if (webView2_13) {
       wil::com_ptr<ICoreWebView2Profile> profile;
       HRESULT hrProfile = webView2_13->get_Profile(&profile);
       if (SUCCEEDED(hrProfile) && profile) {
         profile->put_PreferredColorScheme(
           static_cast<COREWEBVIEW2_PREFERRED_COLOR_SCHEME>(
             newSettings->preferredColorScheme.value()));
       }
     }
   }
   ```

#### CHANGELOG Entry

```markdown
- Implemented `preferredColorScheme` property of `InAppWebViewSettings` to control WebView2 color scheme (Light/Dark/Auto) via `ICoreWebView2Profile.PreferredColorScheme` (requires WebView2 Runtime 1.0.1901.177+)
```

---

## Build Process

1. **Code Generation**: Ran `npm run build` (executes `build_runner build` in platform_interface)
   - Generated 937 outputs (1885 actions)
   - Completed successfully in ~39 seconds

2. **Analysis**: Ran `flutter analyze` on platform_interface package
   - No new errors introduced
   - Only pre-existing warnings remain

---

## Usage Example

```dart
// Set preferred color scheme when creating WebView
InAppWebView(
  initialSettings: InAppWebViewSettings(
    preferredColorScheme: PreferredColorScheme.DARK,
  ),
  // ...
)

// Or update at runtime
await controller.setSettings(
  settings: InAppWebViewSettings(
    preferredColorScheme: PreferredColorScheme.LIGHT,
  ),
);

// Use AUTO to match system theme
await controller.setSettings(
  settings: InAppWebViewSettings(
    preferredColorScheme: PreferredColorScheme.AUTO,
  ),
);
```

---

## Technical Details

### Enum Value Mapping

| Dart Enum                    | C++ Value | WebView2 Constant                           |
| ---------------------------- | --------- | ------------------------------------------- |
| `PreferredColorScheme.AUTO`  | 0         | `COREWEBVIEW2_PREFERRED_COLOR_SCHEME_AUTO`  |
| `PreferredColorScheme.LIGHT` | 1         | `COREWEBVIEW2_PREFERRED_COLOR_SCHEME_LIGHT` |
| `PreferredColorScheme.DARK`  | 2         | `COREWEBVIEW2_PREFERRED_COLOR_SCHEME_DARK`  |

### Platform Support Check

The implementation includes proper version checking using `isWebView2VersionAtLeast("1.0.1901.177")` to ensure the API is available before attempting to use it.

### Lifecycle Management

- **Initialization**: Applied during WebView creation in `prepare()` method
- **Runtime Updates**: Applied when settings change via `setSettings()` method
- **Reading Current Value**: Implemented in `getRealSettings()` for retrieving current state

---

## Testing Recommendations

1. **Basic Functionality**
   - Set each color scheme value (LIGHT, DARK, AUTO)
   - Verify WebView content renders with correct theme

2. **Runtime Updates**
   - Change color scheme while WebView is active
   - Verify theme updates without requiring page reload

3. **Version Compatibility**
   - Test on WebView2 Runtime < 1.0.1901.177 (should gracefully ignore setting)
   - Test on WebView2 Runtime >= 1.0.1901.177 (should apply setting)

4. **Default Behavior**
   - Verify default value (AUTO) is applied when not explicitly set
   - Confirm AUTO matches system theme preference

---

## Files Modified Summary

### Created (2 files)

1. `flutter_inappwebview_platform_interface/lib/src/types/preferred_color_scheme.dart`
2. `flutter_inappwebview_platform_interface/lib/src/types/preferred_color_scheme.g.dart` (generated)

### Modified (8 files)

1. `flutter_inappwebview_platform_interface/lib/src/types/main.dart`
2. `flutter_inappwebview_platform_interface/lib/src/in_app_webview/in_app_webview_settings.dart`
3. `flutter_inappwebview_platform_interface/lib/src/in_app_webview/in_app_webview_settings.g.dart` (regenerated)
4. `flutter_inappwebview_platform_interface/CHANGELOG.md`
5. `flutter_inappwebview_windows/windows/in_app_webview/in_app_webview_settings.h`
6. `flutter_inappwebview_windows/windows/in_app_webview/in_app_webview_settings.cpp`
7. `flutter_inappwebview_windows/windows/in_app_webview/in_app_webview.cpp`
8. `flutter_inappwebview_windows/CHANGELOG.md`

---

## Implementation Notes

### Challenges Encountered

1. **Missing Property Declaration**: Initial implementation had constructor parameter but missing class property - fixed by adding property declaration at line 2014
2. **Unicode Encoding**: File contained Unicode apostrophe characters that prevented standard string replacement - resolved using PowerShell regex injection
3. **File Caching**: Had to use PowerShell to verify actual file content due to apparent editor caching

### Architecture Adherence

- Followed federated plugin pattern correctly
- Platform interface defines the contract
- Windows implementation provides platform-specific code
- Proper use of `@SupportedPlatforms` annotation
- Proper use of `@ExchangeableEnum` for code generation
- Default value (AUTO) aligns with WebView2 default behavior

---

## References

- [WebView2 ICoreWebView2Profile Interface](https://learn.microsoft.com/en-us/microsoft-edge/webview2/reference/win32/icorewebview2profile?view=webview2-1.0.1901.177)
- [WebView2 PreferredColorScheme Property](https://learn.microsoft.com/en-us/microsoft-edge/webview2/reference/win32/icorewebview2profile?view=webview2-1.0.1901.177#get_preferredcolorscheme)
- [COREWEBVIEW2_PREFERRED_COLOR_SCHEME Enum](https://learn.microsoft.com/en-us/microsoft-edge/webview2/reference/win32/webview2-idl?view=webview2-1.0.1901.177#corewebview2_preferred_color_scheme)
